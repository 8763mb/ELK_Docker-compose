# Genie Syslog RTF Parser Pipeline
input {
  file {
    path => "/usr/share/logstash/data/syslog format.rtf"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    mode => "read"
  }
}

filter {
  # 1. 只保留以 <57> 開頭的有效 syslog 行 //是Log
  if [message] !~ /^<57>/ {
    drop { }
  }

  # 2. 清理 RTF 格式標記 - 使用 Ruby
  ruby {
    code => '
      msg = event.get("message")
      if msg
        msg = msg.gsub(/\{\\field.*?\}\}\}/, "")
        msg = msg.gsub(/\{\\rtf.*?\}/, "")
        msg = msg.gsub(/<a href=.*?<\/a>/, "")
        msg = msg.gsub(/\\[a-z]+[0-9]*\s*/, "")
        msg = msg.gsub(/[{}]/, "")
        msg = msg.gsub(/\\/, "")
        event.set("message", msg)
      end
    '
  }

  # 3. 提取 syslog 格式的基本字段
  grok {
    match => {
      "message" => "^<%{NUMBER:priority}>%{SYSLOGTIMESTAMP:syslog_timestamp} %{HOSTNAME:hostname} %%{DATA:facility}: %{GREEDYDATA:raw_message}"
    }
  }

  # 4. 解析分號分隔的鍵值對
  kv {
    source => "raw_message"
    field_split => ";"
    value_split => ":"
    trim_key => " "
    trim_value => " "
    target => "fields"
  }

  # 5. 清理字段
  mutate {
    convert => {
      "[fields][Resource ID]" => "integer"
      "priority" => "integer"
    }
    remove_field => ["raw_message", "path", "host"]
  }

  # 6. 解析時間戳
  date {
    match => ["syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss"]
    timezone => "Asia/Taipei"
    target => "@timestamp"
  }

  # 7. 新增標籤和元數據
  mutate {
    add_field => {
      "source_file" => "syslog format.rtf"
      "log_type" => "genie_ddos"
    }
  }

  # 8. 將 fields 中的資料提升到頂層
  ruby {
    code => '
      fields = event.get("fields")
      if fields
        fields.each do |key, value|
          new_key = key.downcase.gsub(" ", "_")
          event.set(new_key, value)
        end
      end
    '
  }

  # 9. 清理不需要的字段
  mutate {
    remove_field => ["fields", "syslog_timestamp"]
  }
}

output {
  # 輸出到 Kafka topic "genie"
  kafka {
    bootstrap_servers => "kafka:9092"
    topic_id => "genie"
    codec => json
    compression_type => "snappy"
  }

  # 輸出到 Elasticsearch
  elasticsearch {
    hosts    => ["https://elasticsearch:9200"]
    user     => "elastic"
    password => "${ELASTIC_PASSWORD}"
    ssl_enabled => true
    ssl_certificate_authorities => "/usr/share/logstash/config/certs/ca.crt"
    index    => "genie-logs-%{+YYYY.MM.dd}"
  }

  # 調試輸出（可選）
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
